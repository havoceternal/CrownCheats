local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TextChatService = game:GetService("TextChatService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local generalChannel = TextChatService:FindFirstChild("RBXGeneral", true)

local Player = game.Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")

local Character, HRP, Humanoid, HumanoidRootPart, LocalBodyEffects, LocalKO, LocalDead, Framework

local Camera = workspace.CurrentCamera
local Mouse = Player:GetMouse()

local DataFolder = Player:WaitForChild("DataFolder")
local InventoryFolder = DataFolder:WaitForChild("Inventory")

local ClientAnimations = ReplicatedStorage:WaitForChild("ClientAnimations")
local MainEvent = ReplicatedStorage:WaitForChild("MainEvent")

local function Setup(c)
	Character = c
	Framework = PlayerGui:WaitForChild("Framework")

	HRP = c:WaitForChild("HumanoidRootPart")
	Humanoid = c:WaitForChild("Humanoid")
	HumanoidRootPart = c:WaitForChild("HumanoidRootPart")

	LocalBodyEffects = c:WaitForChild("BodyEffects")
	LocalKO = LocalBodyEffects:WaitForChild("K.O")
	LocalDead = LocalBodyEffects:WaitForChild("Dead")
end

Player.CharacterAdded:Connect(Setup)
Setup(Player.Character or Player.CharacterAdded:Wait())

local Logic = {}

local IgnoredShop = workspace.Ignored.Shop

-- Utility Functions
local function checkFriend(target)
	return Player:IsFriendsWith(target.UserId)
end

local function checkCrew(target)
	if not (target and target:IsDescendantOf(game.Players)) then
		return false
	end
	local success, result = pcall(function()
		local ourInfo = DataFolder:FindFirstChild("Information")
		local theirInfo = target:FindFirstChild("DataFolder")
			and target.DataFolder:FindFirstChild("Information")
		if not (ourInfo and theirInfo) then return false end

		local ourCrew = ourInfo:FindFirstChild("Crew")
		local theirCrew = theirInfo:FindFirstChild("Crew")
		if not (ourCrew and theirCrew) then return false end

		if ourCrew.Value == "" or theirCrew.Value == "" then
			return false
		end

		return ourCrew.Value == theirCrew.Value
	end)

	if success then
		return result
	else
		return checkCrew(target)
	end
end

local function GetClosestPlayerToMouse(settings)
	local closestPlayer = nil
	local shortestDistance = math.huge
	local mousePos = Vector2.new(Mouse.X, Mouse.Y)
	for _, target in ipairs(Players:GetPlayers()) do
		if target ~= Player and target.Character then
			local targetRoot = target.Character:FindFirstChild("HumanoidRootPart")
			if targetRoot then
				if target == Player 
					or not target.Character 
					or not target.Character:FindFirstChild("HumanoidRootPart")
					or not target.Character:FindFirstChild("BodyEffects")
					or not target.Character.BodyEffects:FindFirstChild("K.O")
					or not target.Character.BodyEffects:FindFirstChild("Dead") then
					continue
				end
				if table.find(settings, "CheckCrew") and checkCrew(target) then
					continue
				end
				if table.find(settings, "CheckFriends") and checkFriend(target) then
					continue
				end
				if table.find(settings, "CheckKnocked") and target.Character.BodyEffects:FindFirstChild("K.O").Value then
					continue
				end
				local screenPos, onScreen = Camera:WorldToViewportPoint(targetRoot.Position)
				if onScreen then
					local screenVector = Vector2.new(screenPos.X, screenPos.Y)
					local distance = (screenVector - mousePos).Magnitude
					if distance < shortestDistance then
						shortestDistance = distance
						closestPlayer = target
					end
				end
			end
		end
	end

	return closestPlayer
end
--GetClosestPlayerToMouse({"CheckFriends","CheckCrew"})
local function GetClosestPlayerToCharacter(settings)
	local closestPlayer = nil
	local shortestDistance = math.huge
	if not (Character and Character:FindFirstChild("HumanoidRootPart")) then
		return nil
	end
	local myPos = HumanoidRootPart.Position
	for _, target in ipairs(Players:GetPlayers()) do
		if target ~= Player
			and target.Character
			and target.Character:FindFirstChild("HumanoidRootPart")
			and target.Character:FindFirstChild("BodyEffects")
			and target.Character.BodyEffects:FindFirstChild("K.O")
			and target.Character.BodyEffects:FindFirstChild("Dead") then
			if (table.find(settings, "CheckFriends") and checkFriend(target))
				or (table.find(settings, "CheckCrew") and checkCrew(target))
				or (table.find(settings, "CheckKnocked") and target.Character.BodyEffects:FindFirstChild("K.O").Value == true) then
				continue
			end
			local theirPos = target.Character.HumanoidRootPart.Position
			local distance = (theirPos - myPos).Magnitude
			if distance < shortestDistance then
				shortestDistance = distance
				closestPlayer = target
			end
		end
	end
	return closestPlayer
end
--GetClosestPlayerToCharacter({"CheckFriends","CheckCrew","CheckKnocked"})

local function runLoop(controlObj, loopFn)
	if type(controlObj) == "string" then
		local keybind
		if controlObj:sub(1,1) == "!" then
			keybind = Options[controlObj:sub(2)]
		else
			keybind = Options[controlObj]
		end
		task.spawn(function()
			--pcall(function()
			if controlObj:sub(1,1) == "!" then
				while true do
					local state = keybind:GetState()
					if state then
						loopFn()
					end
					RunService.Heartbeat:Wait()
				end
			end
			while task.wait() do
				local state = keybind:GetState()
				if state then
					loopFn()
				end
			end
			--end)
		end)
		return
	end
	if controlObj.OnChanged then
		local loopTask
		controlObj:OnChanged(function()
			if controlObj.Value then
				if not loopTask then
					loopTask = task.spawn(function()
						--pcall(function()
						while controlObj.Value do
							task.wait()
							loopFn()
						end
						loopTask = nil
						--end)
					end)
				end
			else
				loopTask = nil
			end
		end)
	end
end

function Logic:Initialize(uiRefs)
	-- Store UI references
	_G.Toggles = uiRefs.Toggles
	_G.Options = uiRefs.Options
	Toggles = uiRefs.Toggles
	Options = uiRefs.Options
	
	pcall(function()
		LPH_NO_VIRTUALIZE = function(...) return (...) end
		local newindex; newindex = hookmetamethod(game, "__newindex", LPH_NO_VIRTUALIZE(function(self, key, value)
			local calling_script = getcallingscript()
			if Framework and calling_script == Framework and self:IsA("Camera") and key == "CFrame" then 
				if Toggles.NoRecoil.Value then
					return
				end
			end
			if key == 'WalkSpeed' then 
				if Toggles.WalkSpeedToggle.Value then
					value = Options.WalkSpeed.Value
				elseif Toggles.AntiSlow.Value and not Toggles.WalkSpeedToggle.Value then
					if value ~= 22 and value ~= 16 then
						return
					end
				end
			end
			if key == "JumpPower" then 
				if Toggles.JumpPowerToggle.Value then
					value = Options.JumpPower.Value
				elseif Toggles.AntiJumpCooldown.Value and not Toggles.JumpPowerToggle.Value then
					value = 50
				end
			end
			return newindex(self, key, value)
		end))
	end)

	-- MAIN TAB LOOPS
	
end

return Logic
